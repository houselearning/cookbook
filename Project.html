<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>House Learning Cookbook</title>
	<!-- ...existing code... -->
	<!-- CDN libs: Firebase, markdown-it, html2canvas, jsPDF -->
	<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<style>
		/* minimal styles for cookbook layout */
		.cookbook { max-width: 980px; margin: 24px auto; font-family: Arial, sans-serif; }
		.header { display:flex; justify-content:space-between; align-items:center; }
		.sections { display:flex; gap:16px; margin-top:16px; }
		.column { flex:1; border:1px solid #ddd; padding:12px; border-radius:6px; min-height:300px; }
		.recipe { border-bottom:1px dashed #eee; padding:8px 0; }
		.watermark { position:fixed; pointer-events:none; opacity:0.06; font-size:120px; transform:rotate(-30deg); left:10%; top:30%; }
	</style>
</head>
<body>
	<div class="cookbook">
		<div class="header">
			<h1>House Learning Cookbook</h1>
			<div>
				<button id="cookbookBtn">Open Cookbook</button>
				<button id="signOutBtn" style="display:none">Sign out</button>
			</div>
		</div>

		<!-- modal / main content (hidden until clicked and authed) -->
		<div id="cookbookApp" style="display:none">
			<div class="sections">
				<div class="column" id="myRecipesCol">
					<h3>My Recipe</h3>
					<div id="myRecipes"></div>
				</div>
				<div class="column" id="dailyRecipeCol">
					<h3>Daily Recipe</h3>
					<div id="dailyRecipe"></div>
				</div>
				<div class="column" id="assignedRecipeCol">
					<h3>Assigned Recipe</h3>
					<div id="assignedRecipe"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- watermark overlay (for pdf screenshots) -->
	<div class="watermark" id="pdfWatermark">House Learning</div>

	<script>
	// filepath: d:\Downloads\Project.html
	// Firebase config placeholder -- replace with project config
	const firebaseConfig = {
		apiKey: "API_KEY",
		authDomain: "PROJECT.firebaseapp.com",
		projectId: "PROJECT",
		storageBucket: "PROJECT.appspot.com",
		messagingSenderId: "SENDER_ID",
		appId: "APP_ID"
	};
	firebase.initializeApp(firebaseConfig);
	const auth = firebase.auth();
	const db = firebase.firestore();

	// App configuration: endpoints (set to your Apps Script / server endpoints)
	const APPSCRIPT_BASE = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // likes/ratings/reports
	const SERVER_API = "https://your-server.example.com"; // optional server endpoints

	const md = window.markdownit();

	// UI elements
	const cookbookBtn = document.getElementById('cookbookBtn');
	const signOutBtn = document.getElementById('signOutBtn');
	const cookbookApp = document.getElementById('cookbookApp');
	const myRecipesEl = document.getElementById('myRecipes');
	const dailyRecipeEl = document.getElementById('dailyRecipe');
	const assignedRecipeEl = document.getElementById('assignedRecipe');

	let currentUser = null;
	let userClaims = {};

	// Auth state listener and role-based access
	auth.onAuthStateChanged(async (user) => {
		currentUser = user;
		if (!user) {
			signOutBtn.style.display = 'none';
			// signed-out users cannot access cookbook
			cookbookApp.style.display = 'none';
			return;
		}
		signOutBtn.style.display = 'inline-block';
		// get custom claims for roles (set server-side)
		const token = await user.getIdTokenResult();
		userClaims = token.claims || {};
	});

	cookbookBtn.addEventListener('click', async () => {
		if (!auth.currentUser) {
			alert('Please sign in to access the Cookbook.');
			return;
		}
		// check account restriction flag in Firestore (example)
		const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
		const data = userDoc.exists ? userDoc.data() : {};
		if (data.blockedCookbook) {
			alert('Your account is blocked from accessing the Cookbook. Contact admin.');
			return;
		}
		cookbookApp.style.display = 'block';
		loadAllSections();
	});

	signOutBtn.addEventListener('click', () => auth.signOut());

	// Load sections
	async function loadAllSections() {
		loadDailyRecipe();
		loadFavorites();
		loadAssignedRecipe();
	}

	// Load daily recipe from Firestore
	async function loadDailyRecipe() {
		const doc = await db.collection('cookbook').doc('dailyRecipe').get();
		if (!doc.exists) { dailyRecipeEl.innerHTML = '<em>No daily recipe yet.</em>'; return; }
		const r = doc.data();
		renderRecipeCard(dailyRecipeEl, r, { allowPrint: true, allowLike: true, allowFavorite: true, allowedRoles: ['teacher','student','admin'] });
	}

	// Load favorites (My Recipe) from Firestore
	async function loadFavorites() {
		const uid = auth.currentUser.uid;
		const favs = await db.collection('userFavorites').doc(uid).collection('recipes').get();
		myRecipesEl.innerHTML = '';
		if (favs.empty) { myRecipesEl.innerHTML = '<em>No favorites yet.</em>'; return; }
		favs.forEach(doc => {
			renderRecipeCard(myRecipesEl, doc.data(), { allowPrint:true, allowUnfavorite:true });
		});
	}

	// Load assigned recipes: only visible to student/teacher via custom claim
	async function loadAssignedRecipe() {
		if (!userClaims.student && !userClaims.teacher && !userClaims.admin) {
			assignedRecipeEl.innerHTML = '<em>Assigned recipes visible to students/teachers only.</em>';
			return;
		}
		// example: fetch assigned recipes for this user
		const uid = auth.currentUser.uid;
		const assigned = await db.collection('assignedRecipes').where('assignedTo', 'array-contains', uid).get();
		assignedRecipeEl.innerHTML = '';
		if (assigned.empty) assignedRecipeEl.innerHTML = '<em>No assigned recipes.</em>';
		assigned.forEach(doc => renderRecipeCard(assignedRecipeEl, doc.data(), { allowPrint:true, allowReport:true }));
	}

	// Helper: render a recipe card from recipe object {id, title, markdown, html, author, createdAt}
	function renderRecipeCard(container, recipe, opts = {}) {
		const node = document.createElement('div');
		node.className = 'recipe';
		node.innerHTML = `
			<h4>${escapeHtml(recipe.title || 'Untitled')}</h4>
			<div class="recipeBody">${recipe.html ? recipe.html : md.render(recipe.markdown || '')}</div>
			<div style="margin-top:8px;">
				<button data-action="print">Print</button>
				<button data-action="like">Like</button>
				<button data-action="favorite">${opts.allowUnfavorite ? 'Unfavorite' : 'Favorite'}</button>
				<button data-action="rate">Rate</button>
				<button data-action="report">Report</button>
			</div>
		`;
		// Bind actions
		node.querySelector('[data-action="print"]').addEventListener('click', () => printRecipeToPdf(recipe));
		node.querySelector('[data-action="like"]').addEventListener('click', () => sendLike(recipe));
		node.querySelector('[data-action="favorite"]').addEventListener('click', () => toggleFavorite(recipe, opts.allowUnfavorite));
		node.querySelector('[data-action="rate"]').addEventListener('click', () => openRateDialog(recipe));
		node.querySelector('[data-action="report"]').addEventListener('click', () => openReportDialog(recipe));
		container.appendChild(node);
	}

	// Favorite saved in Firestore under userFavorites
	async function toggleFavorite(recipe, isUnfavorite=false) {
		const uid = auth.currentUser.uid;
		const ref = db.collection('userFavorites').doc(uid).collection('recipes').doc(recipe.id || recipe.title);
		if (isUnfavorite) {
			await ref.delete();
			alert('Removed from favorites.');
			loadFavorites();
			return;
		}
		await ref.set({ ...recipe, favoritedAt: firebase.firestore.FieldValue.serverTimestamp() });
		alert('Added to favorites.');
		loadFavorites();
	}

	// Like: send POST to Google Apps Script (does not count favorites)
	async function sendLike(recipe) {
		const payload = {
			type: 'like',
			userId: auth.currentUser.uid,
			recipeId: recipe.id || recipe.title,
			timestamp: new Date().toISOString()
		};
		await fetch(APPSCRIPT_BASE + '?action=like', {
			method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
		});
		alert('Thanks for liking!');
	}

	// Rate: open simple prompt, post to Apps Script
	async function openRateDialog(recipe) {
		const stars = prompt('Rate 1-5 stars (numeric):');
		if (!stars) return;
		const comment = prompt('Optional comment:') || '';
		const payload = {
			type: 'rating',
			userId: auth.currentUser.uid,
			recipeId: recipe.id || recipe.title,
			rating: Number(stars),
			comment,
			timestamp: new Date().toISOString()
		};
		await fetch(APPSCRIPT_BASE + '?action=rating', {
			method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
		});
		alert('Rating submitted. Thank you.');
	}

	// Report: open reason prompt and send to Apps Script (moderation handled server-side)
	async function openReportDialog(recipe) {
		const reason = prompt('Describe the issue with this recipe:');
		if (!reason) return;
		const payload = {
			type: 'report',
			userId: auth.currentUser.uid,
			recipeId: recipe.id || recipe.title,
			reason,
			ip: 'client-ip-not-available', // server/Apps Script can capture IP from request
			timestamp: new Date().toISOString()
		};
		await fetch(APPSCRIPT_BASE + '?action=report', {
			method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
		});
		alert('Report submitted. House Learning Community Team will respond in 2â€“3 days.');
	}

	// Print to PDF with faint watermark using html2canvas + jsPDF
	async function printRecipeToPdf(recipe) {
		// create a temporary element for printing (reuse recipe.html)
		const el = document.createElement('div');
		el.style.padding = '20px';
		el.style.background = '#fff';
		el.innerHTML = `<h1>${escapeHtml(recipe.title)}</h1>` + (recipe.html ? recipe.html : md.render(recipe.markdown || ''));
		document.body.appendChild(el);
		// show watermark element during capture
		const watermark = document.getElementById('pdfWatermark');
		watermark.style.display = 'block';
		// capture
		const canvas = await html2canvas(el, { scale: 2 });
		const imgData = canvas.toDataURL('image/png');
		const { jsPDF } = window.jspdf;
		const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
		const imgProps = pdf.getImageProperties(imgData);
		const pdfWidth = pdf.internal.pageSize.getWidth();
		const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
		pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
		// watermark as faint text on each page (example)
		pdf.setTextColor(0,0,0);
		pdf.setFontSize(60);
		pdf.setGState(new pdf.GState({ opacity: 0.06 }));
		pdf.text('House Learning', pdfWidth * 0.1, pdfHeight * 0.4, {angle: -30});
		// save
		pdf.save((recipe.title || 'recipe') + '.pdf');
		// cleanup
		watermark.style.display = 'none';
		document.body.removeChild(el);
	}

	// Utility: escape HTML for titles
	function escapeHtml(s) {
		return (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
	}

	// On load: nothing visible until user clicks CookBook and is signed-in
	</script>
</body>
</html>